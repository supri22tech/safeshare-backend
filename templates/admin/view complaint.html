{% extends 'adminindex.html' %}
{% block body %}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

<style>
    /* UNIFIED THEME: Forced White Background */
    #content-wrapper, #content {
        background-color: #f8fafc !important;
    }

    .unified-container {
        background: #ffffff;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        overflow: hidden;
        margin-top: 20px;
    }

    .unified-header {
        background: #ffffff;
        padding: 20px 25px;
        border-bottom: 1px solid #e2e8f0;
    }

    /* UNIFIED TABLE HEAD: Black BG, White Text (As per Expert Verification) */
    .table thead th {
        background-color: #000000 !important;
        color: #ffffff !important;
        font-weight: 600;
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        padding: 18px 25px;
        border: none;
    }

    /* UNIFIED TABLE BODY: Pure Black Text */
    .table tbody td {
        color: #000000 !important;
        padding: 20px 25px;
        border-bottom: 1px solid #f1f5f9;
        vertical-align: middle;
        background-color: #ffffff !important;
    }

    /* Expert-Style Squircle Avatar */
    .identity-box {
        width: 45px;
        height: 45px;
        object-fit: cover;
        border-radius: 10px;
        border: 1px solid #e2e8f0;
        background: #f1f5f9;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        color: #000;
    }

    /* Unified Status Badges */
    .status-pill {
        padding: 5px 12px;
        border-radius: 6px;
        font-size: 0.7rem;
        font-weight: 800;
        text-transform: uppercase;
        display: inline-block;
    }
    .status-pending { background: #fff7ed; color: #9a3412; border: 1px solid #fdba74; }
    .status-resolved { background: #dcfce7; color: #166534; border: 1px solid #86efac; }

    /* Unified Action Button: Solid Black */
    .btn-action-main {
        background: #000000;
        color: #ffffff !important;
        border: none;
        padding: 8px 18px;
        border-radius: 6px;
        font-weight: 700;
        font-size: 0.75rem;
        transition: 0.2s;
        text-transform: uppercase;
    }
    .btn-action-main:hover {
        background: #333333;
        transform: translateY(-1px);
    }

    .content-box {
        background: #f8fafc;
        padding: 12px 15px;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
        font-size: 0.9rem;
        color: #000;
    }
</style>

<div class="container-fluid py-4">
    <div class="unified-container">

        <div class="unified-header d-flex justify-content-between align-items-center">
            <div>
                <h4 class="mb-1 fw-bold text-dark">Complaint Management</h4>
                <p class="text-muted small mb-0">Unified resolution panel for user grievances</p>
            </div>
            <div class="text-end">
                <i class="bi bi-shield-exclamation fs-3 text-dark"></i>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table mb-0">
                <thead>
                    <tr>
                        <th class="text-center">#</th>
                        <th>User Identity</th>
                        <th>Complaint Detail</th>
                        <th class="text-center">Status</th>
                        <th class="text-center">Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for i in data %}
                    <tr>
                        <td class="text-center fw-bold">0{{ forloop.counter }}</td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="identity-box me-3">
                                    {{ i.USER.name|slice:":1"|upper }}
                                </div>
                                <div>
                                    <div class="fw-bold">{{ i.USER.name }}</div>
                                    <div class="text-muted small" style="font-size: 11px;">Ref: #CMP-{{ i.id }}</div>
                                </div>
                            </div>
                        </td>
                        <td style="max-width: 400px;">
                            <div class="content-box">
                                {{ i.complaints }}
                            </div>
                            <div class="mt-1 small text-muted font-monospace" style="font-size: 10px;">
                                <i class="bi bi-clock me-1"></i>{{ i.date }}
                            </div>
                        </td>
                        <td class="text-center">
                            {% if i.reply == "pending" %}
                                <span class="status-pill status-pending">Pending</span>
                            {% else %}
                                <span class="status-pill status-resolved">Resolved</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            {% if i.reply == "pending" %}
                                <button type="button" class="btn btn-action-main"
                                        data-bs-toggle="modal"
                                        data-bs-target="#replyModal"
                                        onclick="setModalId('{{ i.id }}', '{{ i.complaints|escapejs }}')">
                                    <i class="bi bi-reply-fill me-1"></i> Send Reply
                                </button>
                            {% else %}
                                <div class="text-success fw-bold small">
                                    <i class="bi bi-patch-check-fill me-1"></i> Replied
                                </div>
                                <div class="text-muted x-small" style="font-size: 11px;">{{ i.reply }}</div>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="text-center py-5">
                            <i class="bi bi-check2-all display-4 text-muted"></i>
                            <p class="text-muted mt-2">All complaints have been cleared.</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="replyModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 12px;">
            <div class="modal-header bg-black text-white py-3">
                <h6 class="modal-title fw-bold text-uppercase small m-0">Resolution Portal</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="replyForm" method="POST">
                {% csrf_token %}
                <div class="modal-body p-4">
                    <div class="mb-3">
                        <label class="fw-bold text-muted small text-uppercase mb-2 d-block">Complaint Reference</label>
                        <div id="display_complaint" class="p-3 bg-light border rounded small text-dark"></div>
                    </div>

                    <div>
                        <label class="fw-bold text-dark small text-uppercase mb-2 d-block">Official Response</label>
                        <textarea class="form-control border-dark" name="reply" rows="4" required placeholder="Type the resolution details..."></textarea>
                    </div>
                </div>
                <div class="modal-footer border-0 p-3">
                    <button type="button" class="btn btn-light btn-sm fw-bold px-3" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-dark btn-sm fw-bold px-4">Submit Resolution</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    function setModalId(id, complaintText) {
        document.getElementById('replyForm').action = "/myapp/sendreply/" + id + "/";
        document.getElementById('display_complaint').innerText = complaintText;
    }
</script>

{% endblock %}